{% extends 'base2.html' %}
{% load static %}

{% block css %}
  <link href="{% static 'css/offcanvass.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

  <!-- <div class="jumbotron" style="margin-top: 20px; padding:0px;">
    <img class="" src="{% static 'img/main_image.jpg' %}" alt="" style="width: 100%; height:300px;">
  </div> -->

  <div class="container">
    <div class="row">

      <div class="jumbotron" style="margin-top: 15px; padding:0px;">
        <img class="" src="{% static 'img/main_image.jpg' %}" alt="" style="width: 100%; height:300px;">
      </div>

      <!-- col-xs-4 col-sm-2 -->
      <div class="col-md-2 sidebar-offcanvas" id="sidebar">
        <div class="list-group">
          <a href="{% url 'notice:notice_list' %}" class="list-group-item active">공지사항</a>
          <a href="{% url 'weekly:weekly_list' %}" class="list-group-item">본당주보</a>
          <a href="{% url 'schedule:schedule' %}" class="list-group-item">본당일정</a>
          <a href="{% url 'gallery:gallery_list' %}" class="list-group-item">행사사진</a>
        </div>
      </div>
        <!--/.sidebar-offcanvas-->
      <div class="col-md-1">
      </div>

      <div class="col-md-9">

        <h3>{{ notice.title }}</h3>
        <hr style="margin-bottom:10px;">
        <span style="margin-left:10px;">
          <i class="fas fa-user"></i>
          <strong>{{ notice.user.username }}</strong>
        </span>
        <span style="margin-left:20px;">
          <small>
            <i class="far fa-comments"></i>
            {{ comment_count }}
          </small>

        </span>
        <span class="pull-right" style="margin-right:10px;">
          <small>
            <span class="glyphicon glyphicon-time"></span>
            {{ notice.updated_at }}
          </small>
        </span>
        <span class="pull-right" style="margin-right:20px;">
          <small>
            <span class="glyphicon glyphicon-eye-open"></span>
            {{ notice.hits }}
          </small>
        </span>
        <hr style="margin-top:10px;">

        <a href="{% url 'notice:notice_list' %}" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">
          목록
        </a>

        <p class="other_posts pull-right">
          {% if notice.get_previous_by_updated_at %}
            <a href="{{ notice.get_previous_post.get_absolute_url }}" title="View previous weekly" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">
              <!-- &laquo;{{ weekly.get_previous_post }} -->
              이전글
            </a>
          {% endif %}

          {% if notice.get_next_by_updated_at %}
            <a href="{{ notice.get_next_post.get_absolute_url }}" title="View next weekly" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">
              <!-- {{ weekly.get_next_post }}&raquo; -->
              다음글
            </a>
          {% endif %}
        </p>

        <div style="margin-top:70px;">

          {% if notice.photo %}
            <img src="{{ notice.photo.url }}" style="height:750; width: 100%;"/>
          {% endif %}

          {{ notice.content|linebreaks }}

          <br>
          <br>

          <a href="{% url 'notice:notice_list' %}" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">목록</a>

          <p class="other_posts pull-right">
            {% if notice.get_previous_by_updated_at %}
              <a href="{{ notice.get_previous_post.get_absolute_url }}" title="View previous weekly" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">
                이전글
              </a>
            {% endif %}

            {% if notice.get_next_by_updated_at %}
              <a href="{{ notice.get_next_post.get_absolute_url }}" title="View next weekly" class="btn btn-info btn-sm" style="background:#555; border-color:#555;">
                다음글
              </a>
            {% endif %}
          </p>

          <hr>
          <br>
        </div>

        <h3>
          댓글 <i class="far fa-comments"></i>
        </h3>

        {% if user.is_authenticated %}
          <form action="{% url 'notice:comment_new' notice.pk %}" method="post">
            {% csrf_token %}
            <table class="table table-hover">
              <tr>
                <td style="padding-top:20px; padding-right:0px;">{{ form.comment }}</td>
                <td style="padding-top:20px; padding-left:0px;"><input type="submit" value="댓글작성" class="btn btn-default" style="height:75px; width:75px;" /></td>
              </tr>
            </table>
          </form>
        {% endif %}

        {% if notice.noticecomment_set.all %}
          {% for comment in comments %}
            <table class="table table-hover">
              <tr>
                <td>
                <p style="margin-left:20px;">
                  <i class="fas fa-user"></i>
                  <strong>{{ comment.user.last_name }}{{ comment.user.first_name }}</strong>
                  <small style="margin-left:10px; cursor:pointer;">
                    <span class="replies-btn glyphicon glyphicon-share-alt" style="color:#555;"></span>
                    <span class="replies-btn replies-btn-{{ comment.pk }}" name="{{ comment.pk }}">답글</span>
                    <span class="text-danger replies-delete replies-delete-{{ comment.pk }}" name="{{ comment.pk }}" style="display:none;">답글 닫기</span>
                  </small>
                  <small class="pull-right" style="margin-right:20px;">
                    <span class="glyphicon glyphicon-time"></span>
                    {{ comment.updated_at }}
                  </small>
                </p>
                <p style="margin-left:20px;">
                  {{ comment.comment }}
                  {% if comment.user == request.user %}
                    <a href="{{ comment.get_delete_url }}"
                      style="margin-right:20px;"
                      class="pull-right text-danger ajax-post-confirm"
                      data-target-id="comment-{{ comment.pk }}"
                      data-message="삭제하시겠습니까?">
                        <small>삭제</small>
                    </a>

                    <div class="replies-form-{{ comment.pk }}" style="display:none;">
                      <form action="{% url 'notice:comment_new' notice.pk %}" method="post">
                        {% csrf_token %}
                        <table class="table table-hover">
                          <tr>
                            <td style="padding-top:20px; padding-right:0px;">{{ form.comment }}</td>
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <td style="padding-top:20px; padding-left:0px;"><input type="submit" value="댓글작성" class="btn btn-default" style="height:75px; width:75px;" /></td>
                          </tr>
                        </table>
                      </form>
                    </div>

                    {% for replay in comment.replies.all %}
                      <span class="replies">
                        <p style="margin-left:40px; margin-top:20px;">
                          L
                          <i class="fas fa-user"></i>
                          <strong>{{ replay.user.last_name }}{{ replay.user.first_name }}</strong>
                          <small class="pull-right" style="margin-right:40px;">
                            <span class="glyphicon glyphicon-time"></span>
                            {{ replay.updated_at }}
                          </small>
                        </p>
                        <p style="margin-left:55px;">
                          {{ replay.comment }}
                          {% if replay.user == request.user %}
                            <a href="{{ replay.get_delete_url }}"
                            style="margin-right:40px;"
                            class="pull-right text-danger ajax-post-confirm2"
                            data-target-id="comment-{{ replay.pk }}"
                            data-message="삭제하시겠습니까?">
                              <small>삭제</small>
                            </a>
                          {% endif %}
                        </p>
                      </span>
                    {% endfor %}

                  {% endif %}
                </p>
                </td>
              </tr>
            </table>
          {% endfor %}
        {% else %}
          <hr>
          <p style="text-align: center;">
            <i class="fas fa-exclamation-circle"></i>
            등록된 댓글이 없습니다.
          </p>
          <hr>
        {% endif %}

      </div>

    </div>
  </div>
{% endblock %}

{% block extra_body %}
  <script>
    // onClick="location.href='http://www.daum.net/'" style="cursor:pointer;"
    $(function() {
      $(document).on('click', '.ajax-post-confirm', function(e) {
        e.preventDefault();
        var content = $(this).parents().closest('table')
        var url = $(this).attr('href');
        var target_id = $(this).data('target-id');
        var message = $(this).data('message');

        if ( confirm(message) ) {
          $.post(url)
            .done(function() {
              $('#' + target_id).remove();
              $(content).remove();
            })
            .fail(function(xhr, textStatus, errer) {
              alert('failed : ' + errer);
            });
        }
      });
    });

    $(function() {
      $(document).on('click', '.ajax-post-confirm2', function(e) {
        e.preventDefault();
        var content = $(this).parents().closest('span');
        var url = $(this).attr('href');
        var target_id = $(this).data('target-id');
        var message = $(this).data('message');
        console.log(content);

        if ( confirm(message) ) {
          $.post(url)
            .done(function() {
              $('#' + target_id).remove();
              $(content).remove();
            })
            .fail(function(xhr, textStatus, errer) {
              alert('failed : ' + errer);
            });
        }
      });
    });

    $(function() {
      $(document).on('click', '.replies-btn', function(e) {
        var pk = $(this).attr('name');

        $( ".replies-form-"+pk ).show();
        $( ".replies-delete-"+pk ).show();
        $( ".replies-btn-"+pk ).hide();
      });
    });

    $(function() {
      $(document).on('click', '.replies-delete', function(e) {
        var pk = $(this).attr('name');

        $( ".replies-form-"+pk ).hide();
        $( ".replies-delete-"+pk ).hide();
        $( ".replies-btn-"+pk ).show();
      });
    });
  </script>
{% endblock %}
